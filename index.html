<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#111111" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="签到" />
  <title>每日签到</title>

  <link rel="manifest" href="./manifest.webmanifest" />
  <link rel="apple-touch-icon" href="./icon-192.png" />

  <style>
    :root{
      --bg:#0b0b0b;
      --card:#151515;
      --border:#2a2a2a;
      --text:#ffffff;
      --muted:rgba(255,255,255,.72);
      --muted2:rgba(255,255,255,.55);
      --primary:#3b82f6;
      --danger:#ef4444;
      --ok:#22c55e;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial;
      background:var(--bg);
      color:var(--text);
      min-height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:18px;
    }
    .wrap{width:min(520px,94vw)}
    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:20px;
      padding:18px;
      box-shadow:0 10px 30px rgba(0,0,0,.35);
    }
    .top{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      margin-bottom:12px;
    }
    h1{margin:0;font-size:20px;letter-spacing:.5px}
    .badge{
      padding:8px 10px;
      border:1px solid var(--border);
      border-radius:999px;
      font-size:12px;
      color:var(--muted);
      white-space:nowrap;
    }
    .btn{
      width:100%;
      padding:14px 16px;
      border-radius:14px;
      border:0;
      background:var(--primary);
      color:#fff;
      font-size:16px;
      font-weight:700;
      letter-spacing:.2px;
    }
    .btn:disabled{opacity:.55}
    .row{
      display:flex;
      gap:10px;
      margin-top:10px;
    }
    .btn2{
      flex:1;
      padding:12px 12px;
      border-radius:14px;
      border:1px solid var(--border);
      background:transparent;
      color:var(--text);
      font-size:14px;
      font-weight:650;
    }
    .btnDanger{
      border-color:rgba(239,68,68,.55);
      color:#fff;
      background:rgba(239,68,68,.12);
    }
    .grid{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:10px;
      margin-top:12px;
    }
    .stat{
      border:1px solid var(--border);
      border-radius:14px;
      padding:12px;
    }
    .stat .k{font-size:12px;color:var(--muted2)}
    .stat .v{margin-top:6px;font-size:18px;font-weight:800}
    .status{
      margin-top:12px;
      color:var(--muted);
      line-height:1.6;
      font-size:13px;
    }
    .toast{
      margin-top:12px;
      border:1px solid var(--border);
      border-radius:14px;
      padding:10px 12px;
      color:var(--muted);
      font-size:13px;
      display:none;
    }
    .toast.ok{border-color:rgba(34,197,94,.45); background:rgba(34,197,94,.08); color:rgba(255,255,255,.85)}
    .toast.warn{border-color:rgba(245,158,11,.45); background:rgba(245,158,11,.08); color:rgba(255,255,255,.85)}
    .toast.err{border-color:rgba(239,68,68,.45); background:rgba(239,68,68,.08); color:rgba(255,255,255,.85)}
    .footer{
      margin-top:10px;
      color:var(--muted2);
      font-size:12px;
      line-height:1.5;
    }
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace}
    .linkish{color:rgba(59,130,246,.95); text-decoration:underline; cursor:pointer}
    textarea{
      width:100%;
      margin-top:10px;
      border-radius:14px;
      border:1px solid var(--border);
      background:#0f0f0f;
      color:#fff;
      padding:12px;
      min-height:120px;
      resize:vertical;
      font-size:12px;
      display:none;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="top">
        <h1>每日签到</h1>
        <div class="badge" id="todayBadge">今日：--</div>
      </div>

      <button id="checkinBtn" class="btn">今日签到</button>

      <div class="grid">
        <div class="stat">
          <div class="k">连续签到</div>
          <div class="v" id="streakV">0</div>
        </div>
        <div class="stat">
          <div class="k">总签到天数</div>
          <div class="v" id="totalV">0</div>
        </div>
        <div class="stat">
          <div class="k">本月签到</div>
          <div class="v" id="monthV">0</div>
        </div>
        <div class="stat">
          <div class="k">上次签到</div>
          <div class="v mono" id="lastV">--</div>
        </div>
      </div>

      <div class="row">
        <button id="exportBtn" class="btn2">导出数据</button>
        <button id="importBtn" class="btn2">导入数据</button>
        <button id="resetBtn" class="btn2 btnDanger">重置</button>
      </div>

      <textarea id="dataBox" class="mono" spellcheck="false" placeholder="这里会显示导出数据；导入时也把 JSON 粘贴到这里…"></textarea>

      <div class="toast" id="toast"></div>

      <div class="status" id="status"></div>

      <div class="footer">
        数据仅保存在本机浏览器（<span class="mono">localStorage</span>）。清理 Safari 网站数据/换手机会丢失。
        建议偶尔点一次“导出数据”备份。
      </div>
    </div>
  </div>

  <script>
    // ---------- 日历日工具：不按 24 小时差，只按“日历日” ----------
    function ymdLocal(d = new Date()){
      const y = d.getFullYear();
      const m = String(d.getMonth() + 1).padStart(2, '0');
      const day = String(d.getDate()).padStart(2, '0');
      return `${y}-${m}-${day}`;
    }
    function parseYMDLocal(s){
      const [y, m, d] = s.split('-').map(Number);
      return new Date(y, m - 1, d); // 本地时区 00:00
    }
    function dayDiffByCalendar(aYMD, bYMD){
      const a = parseYMDLocal(aYMD);
      const b = parseYMDLocal(bYMD);
      const msPerDay = 24 * 60 * 60 * 1000;
      return Math.round((b - a) / msPerDay);
    }
    function monthKey(ymd){
      // "YYYY-MM-DD" -> "YYYY-MM"
      return ymd.slice(0, 7);
    }

    // ---------- 本地数据读写 ----------
    const STORAGE_KEYS = {
      last: 'last_checkin',
      streak: 'streak',
      total: 'total',
      history: 'history' // JSON array of "YYYY-MM-DD"
    };

    function getHistory(){
      try{
        const raw = localStorage.getItem(STORAGE_KEYS.history);
        const arr = raw ? JSON.parse(raw) : [];
        if(!Array.isArray(arr)) return [];
        // 过滤/去重/排序
        const set = new Set(arr.filter(x => typeof x === 'string' && /^\d{4}-\d{2}-\d{2}$/.test(x)));
        return Array.from(set).sort();
      }catch{
        return [];
      }
    }

    function setHistory(arr){
      const set = new Set(arr.filter(x => typeof x === 'string'));
      const clean = Array.from(set).sort();
      localStorage.setItem(STORAGE_KEYS.history, JSON.stringify(clean));
      return clean;
    }

    function computeMonthCount(history, today){
      const mk = monthKey(today);
      let c = 0;
      for(const d of history){
        if(monthKey(d) === mk) c++;
      }
      return c;
    }

    // ---------- UI ----------
    const btn = document.getElementById('checkinBtn');
    const todayBadge = document.getElementById('todayBadge');
    const streakV = document.getElementById('streakV');
    const totalV = document.getElementById('totalV');
    const monthV = document.getElementById('monthV');
    const lastV = document.getElementById('lastV');
    const statusEl = document.getElementById('status');
    const toastEl = document.getElementById('toast');
    const dataBox = document.getElementById('dataBox');

    const exportBtn = document.getElementById('exportBtn');
    const importBtn = document.getElementById('importBtn');
    const resetBtn = document.getElementById('resetBtn');

    function toast(msg, type='ok'){
      toastEl.className = `toast ${type}`;
      toastEl.textContent = msg;
      toastEl.style.display = 'block';
      setTimeout(() => { toastEl.style.display = 'none'; }, 2200);
    }

    function render(){
      const today = ymdLocal(new Date());
      todayBadge.textContent = `今日：${today}`;

      const last = localStorage.getItem(STORAGE_KEYS.last) || '';
      const streak = Number(localStorage.getItem(STORAGE_KEYS.streak) || '0');
      const total = Number(localStorage.getItem(STORAGE_KEYS.total) || '0');
      const history = getHistory();
      const monthCount = computeMonthCount(history, today);

      // 按日历日：今天签过就禁用
      if(last === today){
        btn.disabled = true;
        btn.textContent = '今天已签到 ✅';
      }else{
        btn.disabled = false;
        btn.textContent = '今日签到';
      }

      streakV.textContent = String(streak);
      totalV.textContent = String(total);
      monthV.textContent = String(monthCount);
      lastV.textContent = last || '--';

      const lastInfo = last ? `上次签到：${last}` : `还没有签到记录`;
      statusEl.innerHTML = `
        ${lastInfo}<br/>
        历史记录：${history.length} 天（仅本机）<br/>
        <span class="mono">提示：</span>要换手机/备份，先点“导出数据”保存 JSON。
      `;
    }

    // ---------- 签到逻辑（按日历日） ----------
    btn.addEventListener('click', () => {
      const today = ymdLocal(new Date());
      const last = localStorage.getItem(STORAGE_KEYS.last) || '';

      // 逻辑层防重复
      if(last === today){
        render();
        toast('今天已经签过啦～', 'warn');
        return;
      }

      let streak = 1;
      if(last){
        const diff = dayDiffByCalendar(last, today);
        if(diff === 1){
          streak = Number(localStorage.getItem(STORAGE_KEYS.streak) || '0') + 1;
        }else{
          streak = 1;
        }
      }

      const total = Number(localStorage.getItem(STORAGE_KEYS.total) || '0') + 1;

      // 更新 history
      const history = getHistory();
      history.push(today);
      setHistory(history);

      localStorage.setItem(STORAGE_KEYS.last, today);
      localStorage.setItem(STORAGE_KEYS.streak, String(streak));
      localStorage.setItem(STORAGE_KEYS.total, String(total));

      // 轻微震动（支持则生效）
      try{ navigator.vibrate?.(20); }catch{}

      render();
      toast('签到成功 ✅', 'ok');
    });

    // ---------- 导出 / 导入 / 重置 ----------
    function showBox(show){
      dataBox.style.display = show ? 'block' : 'none';
    }

    exportBtn.addEventListener('click', async () => {
      const payload = {
        version: 1,
        exportedAt: new Date().toISOString(),
        last_checkin: localStorage.getItem(STORAGE_KEYS.last) || '',
        streak: Number(localStorage.getItem(STORAGE_KEYS.streak) || '0'),
        total: Number(localStorage.getItem(STORAGE_KEYS.total) || '0'),
        history: getHistory()
      };
      const json = JSON.stringify(payload, null, 2);
      dataBox.value = json;
      showBox(true);

      // 复制到剪贴板（可用则复制）
      try{
        await navigator.clipboard.writeText(json);
        toast('已导出并复制到剪贴板', 'ok');
      }catch{
        toast('已导出（可手动复制）', 'ok');
      }
    });

    importBtn.addEventListener('click', () => {
      showBox(true);
      const raw = dataBox.value.trim();
      if(!raw){
        toast('把导出的 JSON 粘贴到下面再点一次“导入数据”', 'warn');
        return;
      }

      let obj;
      try{
        obj = JSON.parse(raw);
      }catch{
        toast('JSON 格式不正确', 'err');
        return;
      }

      const history = Array.isArray(obj.history) ? obj.history : [];
      const cleanedHistory = setHistory(history);

      const last = typeof obj.last_checkin === 'string' ? obj.last_checkin : '';
      const streak = Number.isFinite(obj.streak) ? Number(obj.streak) : 0;
      const total = Number.isFinite(obj.total) ? Number(obj.total) : cleanedHistory.length;

      localStorage.setItem(STORAGE_KEYS.last, last);
      localStorage.setItem(STORAGE_KEYS.streak, String(Math.max(0, Math.floor(streak))));
      localStorage.setItem(STORAGE_KEYS.total, String(Math.max(0, Math.floor(total))));

      render();
      toast('导入成功 ✅', 'ok');
    });

    resetBtn.addEventListener('click', () => {
      const ok = confirm('确定要重置吗？这会清空本机所有签到数据。');
      if(!ok) return;

      localStorage.removeItem(STORAGE_KEYS.last);
      localStorage.removeItem(STORAGE_KEYS.streak);
      localStorage.removeItem(STORAGE_KEYS.total);
      localStorage.removeItem(STORAGE_KEYS.history);

      dataBox.value = '';
      showBox(false);
      render();
      toast('已重置', 'ok');
    });

    // ---------- Service Worker ----------
    if('serviceWorker' in navigator){
      navigator.serviceWorker.register('./sw.js');
    }

    render();
  </script>
</body>
</html>
