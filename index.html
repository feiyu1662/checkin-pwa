<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#111111" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <title>每日签到</title>

  <link rel="manifest" href="./manifest.webmanifest" />
  <link rel="apple-touch-icon" href="./icon-192.png" />

  <style>
    body{margin:0;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial;
      background:#0b0b0b;color:#fff;min-height:100vh;display:flex;align-items:center;justify-content:center;}
    .card{width:min(420px,92vw);background:#151515;border:1px solid #2a2a2a;border-radius:18px;padding:20px;}
    h1{margin:0 0 12px;font-size:22px}
    .btn{width:100%;padding:14px 16px;border-radius:14px;border:0;background:#3b82f6;color:#fff;
      font-size:16px;font-weight:600}
    .btn:disabled{opacity:.5}
    .meta{margin-top:14px;opacity:.85;line-height:1.7}
    .small{margin-top:10px;opacity:.6;font-size:12px}
  </style>
</head>
<body>
  <div class="card">
    <h1>每日签到</h1>
    <button id="checkinBtn" class="btn">今日签到</button>
    <div class="meta" id="status"></div>
    <div class="small"></div>
  </div>

  <script>
    const btn = document.getElementById('checkinBtn');
    const statusEl = document.getElementById('status');

    function ymdLocal(d = new Date()){
  const y = d.getFullYear();
  const m = String(d.getMonth() + 1).padStart(2, '0');
  const day = String(d.getDate()).padStart(2, '0');
  return `${y}-${m}-${day}`;
}

// 把 "YYYY-MM-DD" 解析为 本地时区 的当天 00:00
function parseYMDLocal(s){
  const [y, m, d] = s.split('-').map(Number);
  return new Date(y, m - 1, d);
}

// 只按日历日计算差值：0=同一天，1=昨天，2=前天...
function dayDiffByCalendar(aYMD, bYMD){
  const a = parseYMDLocal(aYMD);
  const b = parseYMDLocal(bYMD);
  const msPerDay = 24 * 60 * 60 * 1000;
  return Math.round((b - a) / msPerDay);
}


    const todayKey = () => {
      const d = new Date();
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,'0');
      const day = String(d.getDate()).padStart(2,'0');
      return `${y}-${m}-${day}`;
    };

    function render(){
      const last = localStorage.getItem('last_checkin') || '';
      const streak = Number(localStorage.getItem('streak') || '0');
      const total = Number(localStorage.getItem('total') || '0');
      const t = todayKey();

      if(last === t){
        btn.disabled = true;
        btn.textContent = '今天已签到';
      }else{
        btn.disabled = false;
        btn.textContent = '今日签到';
      }

      statusEl.innerHTML = `
        今日：${t}<br/>
        上次：${last || '无'}<br/>
        连续：${streak} 天<br/>
        总计：${total} 天
      `;
    }

    btn.addEventListener('click', () => {
      const t = todayKey();
      const last = localStorage.getItem('last_checkin') || '';
      const total = Number(localStorage.getItem('total') || '0');

      // 计算是否昨天（非常简化版）
      let newStreak = 1;
      if(last){
        const a = new Date(last);
        const b = new Date(t);
        const diffDays = Math.round((b - a) / (24*3600*1000));
        if(diffDays === 1) newStreak = Number(localStorage.getItem('streak') || '0') + 1;
        if(diffDays === 0) newStreak = Number(localStorage.getItem('streak') || '0');
      }

      localStorage.setItem('last_checkin', t);
      localStorage.setItem('streak', String(newStreak));
      localStorage.setItem('total', String(total + 1));
      render();
    });

    // 注册 Service Worker（离线/安装更稳定）
    if('serviceWorker' in navigator){
      navigator.serviceWorker.register('./sw.js');
    }

    render();
  </script>
</body>
</html>


